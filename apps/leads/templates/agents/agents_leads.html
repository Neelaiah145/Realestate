{% extends "agent_base.html" %}
{% load static %}

{% block title %}Agent Leads{% endblock %}

{% block content %}

<link rel="stylesheet" href="{% static 'leads/style.css' %}">

<!-- due follow-ups -->
{% if followups %}
<div class="followup-box followup-due">
    <div class="followup-title">
        üì¢ {{ followups.count }} follow-ups due
    </div>
    <div class="followup-list">
        {% for lead in followups %}
        <strong>{{ lead.name }}</strong>
        ({{ lead.follow_up_at|date:"d M Y, h:i A" }})
        {% if not forloop.last %}, {% endif %}
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- upcomming followups -->
{% if upcoming_followups %}
<div class="followup-box followup-upcoming">
    <div class="followup-title">
        ‚è≥ Upcoming follow-ups
    </div>
    <div class="followup-list">
        {% for lead in upcoming_followups %}
        <strong>{{ lead.name }}</strong>
        ({{ lead.follow_up_at|date:"d M Y, h:i A" }})
        {% if not forloop.last %}, {% endif %}
        {% endfor %}
    </div>
</div>
{% endif %}

<h2 class="page-header">
    My Leads
    <span class="lead-count">- ({{ leads.paginator.count }})</span>
</h2>

<form method="get" class="search-form">
    <input type="text" name="q" value="{{ search_query }}" placeholder="Search Lead by Name" class="search-input">
    <button type="submit" class="search-btn">Search</button>

    {% if search_query %}
    <a href="{% url 'agent_leads' %}" class="search-clear">Clear</a>
    {% endif %}
</form>

<table class="leads-table">
    <thead>
        <tr>
            <th>SL.NO</th>
            <th>Name</th>
            <th>Status</th>
            <th>Associate</th>
            <th>Assigned At</th>
            <th>Updated At</th>
            <th>Site Visit Schedule</th>
            <th>Action</th>
        </tr>
    </thead>

    <tbody>
        {% for lead in leads %}
        <tr class="{% if lead.is_due %}lead-due-row{% endif %}">
            <td>{{ leads.start_index|add:forloop.counter0 }}</td>

            <td>{{ lead.name }}</td>

            <td>{{ lead.get_status_display }}</td>

            <!-- ASSOCIATE COLUMN -->
            <td>
                {% if lead.assigned_associate %}
                    <span style="font-weight:500; color:#2563eb;">
                        {{ lead.assigned_associate.username }}
                    </span>
                {% else %}
                    <span style="color:#9ca3af;">‚Äî</span>
                {% endif %}
            </td>

            <td>{{ lead.assigned_at|date:"d M Y - h:i A" }}</td>

            <td>{{ lead.updated_at|date:"d M Y - h:i A" }}</td>

            <!-- visiting schedule -->
            <td style="text-align:center;">
                {% if lead.site_visit_at %}
                <a href="{% url 'set_shedule' lead.id %}"
                   class="action-link site-visit-done"
                   title="Reschedule Site Visit">
                    Site Visit Scheduled
                </a>
                {% else %}
                <a href="{% url 'set_shedule' lead.id %}"
                   class="action-link site-visit-pending"
                   title="Schedule Site Visit">
                    Site Visit Schedule
                </a>
                {% endif %}
            </td>

            <!-- ACTIONS -->
            <td>
                <a href="{% url 'lead_detail' lead.id %}" class="action-link" title="View">üëÅ</a> |

                {% if perms.leads.can_update_lead %}
                <a href="{% url 'update_lead_status' lead.id %}" class="action-link" title="Update">
                    Update
                </a> |
                {% endif %}

                {% if request.user.role == "agent" %}
                <a href="{% url 'move_lead' lead.id %}" class="action-link">
                    Move
                </a> |
                {% endif %}

                {% if perms.leads.can_book_lead %}
                <a href="#" class="action-link booking-link" title="Booking">
                    Booking
                </a> |
                {% endif %}

                {% if perms.leads.can_delete_lead %}
                <form method="post"
                      action="{% url 'delete_lead' lead.id %}"
                      style="display:inline;"
                      onsubmit="return confirm('Delete this lead?');">
                    {% csrf_token %}
                    <button type="submit" class="delete-btn" title="Delete">
                        Delete
                    </button>
                </form>
                {% endif %}
            </td>
        </tr>

        {% empty %}
        <tr>
            <td colspan="8" style="text-align:center;color:#6b7280;">
                No leads available
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>


<!-- set other page/search bar  -->
{% if leads.has_other_pages %}
<div class="pagination">
    {% for num in leads.paginator.page_range %}
    {% if leads.number == num %}
    <span class="page-active">{{ num }}</span>
    {% else %}
    <a href="?page={{ num }}{% if search_query %}&q={{ search_query }}{% endif %}" class="page-link">
        {{ num }}
    </a>
    {% endif %}
    {% endfor %}
</div>
{% endif %}

{% endblock %}