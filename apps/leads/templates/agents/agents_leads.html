{% extends "agent_base.html" %}
{% load static %}

{% block title %}Agent Leads{% endblock %}

{% block content %}

<link rel="stylesheet" href="{% static 'leads/style.css' %}">
{# üîî DUE FOLLOW-UPS #}
{% if followups %}
<div class="followup-box followup-due">
    <div class="followup-title">
        üîî {{ followups.count }} follow-ups due
    </div>
    <div class="followup-list">
        {% for lead in followups %}
            <strong>{{ lead.name }}</strong>
            ({{ lead.follow_up_at|date:"d M H:i" }})
            {% if not forloop.last %}, {% endif %}
        {% endfor %}
    </div>
</div>
{% endif %}

{# ‚è≥ UPCOMING FOLLOW-UPS #}
{% if upcoming_followups %}
<div class="followup-box followup-upcoming">
    <div class="followup-title">
        ‚è≥ Upcoming follow-ups
    </div>
    <div class="followup-list">
        {% for lead in upcoming_followups %}
            <strong>{{ lead.name }}</strong>
            ({{ lead.follow_up_at|date:"d M H:i" }})
            {% if not forloop.last %}, {% endif %}
        {% endfor %}
    </div>
</div>
{% endif %}

<h2 class="page-header">
    My Leads
    <span class="lead-count">- ({{ leads.paginator.count }})</span>
</h2>

<form method="get" class="search-form">
    <input type="text" name="q" value="{{ search_query }}"
           placeholder="Search lead by name"
           class="search-input">
    <button type="submit" class="search-btn"> Search</button>
    {% if search_query %}
        <a href="{% url 'agent_leads' %}" class="search-clear">Clear</a>
    {% endif %}
</form>

<table class="leads-table">
    <thead>
        <tr>
            <th>Sl.No</th>
            <th>Name</th>
            <th>Status</th>
            <th>Assigned At</th>
            <th>Updated At</th>
            <th>Action</th>
        </tr>
    </thead>
    <tbody>
        {% for lead in leads %}
        <tr class="{% if lead.is_due %}lead-due-row{% endif %}">
            <td>{{ leads.start_index|add:forloop.counter0 }}</td>
            <td>{{ lead.name }}</td>
            <td>{{ lead.get_status_display }}</td>
            <td>{{ lead.assigned_at|date:"d M Y H:i" }}</td>
            <td>{{ lead.updated_at|date:"d M Y H:i" }}</td>
            <td>
                <a href="{% url 'lead_detail' lead.id %}" class="action-link">üëÅ</a> |
                <a href="{% url 'update_lead_status' lead.id %}" class="action-link">Update</a> |
                <form method="post" action="{% url 'delete_lead' lead.id %}"
                      style="display:inline;" onsubmit="return confirm('Delete this lead?');">
                    {% csrf_token %}
                    <button type="submit" class="delete-btn">Delete</button>
                </form>
            </td>
        </tr>
        {% empty %}
        <tr>
            <td colspan="6" style="text-align:center;color:#6b7280;">
                No leads available
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

{% if leads.has_other_pages %}
<div class="pagination">
    {% for num in leads.paginator.page_range %}
        {% if leads.number == num %}
            <span class="page-active">{{ num }}</span>
        {% else %}
            <a href="?page={{ num }}{% if search_query %}&q={{ search_query }}{% endif %}"
               class="page-link">{{ num }}</a>
        {% endif %}
    {% endfor %}
</div>
{% endif %}

{% endblock %}
